{% extends 'base.html' %}
{% load static %}

{% block title %}Business Permit Renewal{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header Section -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg p-6 mb-6 shadow-md">
        <h1 class="text-3xl font-bold">Business Permit Renewal</h1>
        <p class="mt-2">Complete the form below to renew your existing business permit</p>
        {% if application_id %}
        <div class="mt-4 flex items-center">
            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="ml-3">
                <span class="text-sm opacity-75">Application ID:</span>
                <span class="text-base font-semibold">{{ application_id }}</span>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Messages/Alerts -->
    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="p-4 mb-2 rounded-md flex items-center {% if message.tags == 'success' %}bg-green-100 text-green-800 border-l-4 border-green-600{% elif message.tags == 'error' %}bg-red-100 text-red-800 border-l-4 border-red-600{% else %}bg-blue-100 text-blue-800 border-l-4 border-blue-600{% endif %}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                {% if message.tags == 'success' %}
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                {% elif message.tags == 'error' %}
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                {% else %}
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                {% endif %}
            </svg>
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- No steps indicator, single form approach -->

    <!-- Main Form -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="p-6 bg-gray-50 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-800">Renewal Application Form</h2>
            <p class="text-gray-600">Fields marked with <span class="text-red-500">*</span> are required</p>
        </div>

        <form method="post" enctype="multipart/form-data" class="p-6" id="renewalForm">
            {% csrf_token %}

            <!-- Basic Information Section -->
            <div class="mb-8">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Basic Information</h3>
                </div>
                
                <div class="bg-white p-4 rounded-md border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="{{ form.payment_mode.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Payment Mode <span class="text-red-500">*</span></label>
                            {{ form.payment_mode }}
                            {% if form.payment_mode.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.payment_mode.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.previous_permit_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Current Permit Number <span class="text-red-500">*</span></label>
                            {{ form.previous_permit_number }}
                            {% if form.previous_permit_number.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.previous_permit_number.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.business_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Business Name <span class="text-red-500">*</span></label>
                            {{ form.business_name }}
                            {% if form.business_name.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.business_name.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.registration_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Registration Number</label>
                            {{ form.registration_number }}
                            {% if form.registration_number.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.registration_number.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Business Details Section -->
            <div class="mb-8">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Business Details</h3>
                </div>
                
                <div class="bg-white p-4 rounded-md border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group col-span-1 md:col-span-2">
                            <label for="{{ form.business_address.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Business Address</label>
                            {{ form.business_address }}
                            {% if form.business_address.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.business_address.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.postal_code.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Postal Code</label>
                            {{ form.postal_code }}
                            {% if form.postal_code.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.postal_code.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.telephone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Telephone Number</label>
                            {{ form.telephone }}
                            {% if form.telephone.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.telephone.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            {{ form.email }}
                            {% if form.email.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.email.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.registration_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Registration Date</label>
                            {{ form.registration_date }}
                            {% if form.registration_date.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.registration_date.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Information Section -->
            <div class="mb-8">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Financial Information</h3>
                </div>
                
                <div class="bg-white p-4 rounded-md border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="{{ form.gross_essential.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Essential Goods (₱)</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">₱</span>
                                </div>
                                {{ form.gross_essential }}
                            </div>
                            {% if form.gross_essential.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.gross_essential.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.gross_non_essential.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Non-Essential Goods (₱)</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">₱</span>
                                </div>
                                {{ form.gross_non_essential }}
                            </div>
                            {% if form.gross_non_essential.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.gross_non_essential.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="form-group col-span-1 md:col-span-2">
                            <label for="{{ form.gross_sales_receipts.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Total Gross Sales (₱)</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">₱</span>
                                </div>
                                {{ form.gross_sales_receipts }}
                            </div>
                            <p class="text-gray-500 text-xs mt-1">Calculated automatically from Essential and Non-Essential values</p>
                            {% if form.gross_sales_receipts.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.gross_sales_receipts.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document Upload Section -->
            <div class="mb-8">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Required Documents</h3>
                </div>
                
    <div class="bg-white p-4 rounded-md border border-gray-200">
        <div class="mb-6">
            <div class="bg-white shadow overflow-hidden sm:rounded-md">
                <ul role="list" class="divide-y divide-gray-200">
                    <!-- Previous Business Permit -->
                    <li>
                        <div class="px-4 py-4 sm:px-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-900">Previous Business Permit</p>
                                        <p class="text-xs text-gray-500">PDF, JPG or PNG (Max 10MB)</p>
                                    </div>
                                </div>
                                <div class="flex">
                                    <button type="button" onclick="openCamera('business_permit')" class="mr-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        Camera
                                    </button>
                                    <div class="relative">
                                        <input type="file" id="business_permit" name="business_permit" accept=".pdf,.jpg,.jpeg,.png" class="hidden" onchange="handleFileSelect(this)">
                                        <label for="business_permit" class="cursor-pointer inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                            <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                            </svg>
                                            Upload
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div id="business_permit_preview" class="hidden mt-3 p-2 border rounded-md bg-gray-50">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs font-medium text-gray-900 document-name"></span>
                                    <button type="button" onclick="removeFile('business_permit')" class="text-red-600 hover:text-red-800">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>

                    <!-- Breakdown of Sales per Branch -->
                    <li>
                        <div class="px-4 py-4 sm:px-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-900">Breakdown of Sales per Branch</p>
                                        <p class="text-xs text-gray-500">PDF, Excel, JPG or PNG (Max 10MB)</p>
                                    </div>
                                </div>
                                <div class="flex">
                                    <button type="button" onclick="openCamera('sales_breakdown')" class="mr-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        Camera
                                    </button>
                                    <div class="relative">
                                        <input type="file" id="sales_breakdown" name="sales_breakdown" accept=".pdf,.xls,.xlsx,.jpg,.jpeg,.png" class="hidden" onchange="handleFileSelect(this)">
                                        <label for="sales_breakdown" class="cursor-pointer inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                            <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                            </svg>
                                            Upload
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div id="sales_breakdown_preview" class="hidden mt-3 p-2 border rounded-md bg-gray-50">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs font-medium text-gray-900 document-name"></span>
                                    <button type="button" onclick="removeFile('sales_breakdown')" class="text-red-600 hover:text-red-800">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>

                    <!-- Book of Sales -->
                    <li>
                        <div class="px-4 py-4 sm:px-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-900">Book of Sales</p>
                                        <p class="text-xs text-gray-500">PDF, Excel, JPG or PNG (Max 10MB)</p>
                                    </div>
                                </div>
                                <div class="flex">
                                    <button type="button" onclick="openCamera('book_of_sales')" class="mr-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        Camera
                                    </button>
                                    <div class="relative">
                                        <input type="file" id="book_of_sales" name="book_of_sales" accept=".pdf,.xls,.xlsx,.jpg,.jpeg,.png" class="hidden" onchange="handleFileSelect(this)">
                                        <label for="book_of_sales" class="cursor-pointer inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                            <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                            </svg>
                                            Upload
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div id="book_of_sales_preview" class="hidden mt-3 p-2 border rounded-md bg-gray-50">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs font-medium text-gray-900 document-name"></span>
                                    <button type="button" onclick="removeFile('book_of_sales')" class="text-red-600 hover:text-red-800">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>

                    <!-- POS Reports (if applicable) -->
                    <li>
                        <div class="px-4 py-4 sm:px-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-900">POS Reports (if applicable)</p>
                                        <p class="text-xs text-gray-500">PDF, Excel, JPG or PNG (Max 10MB)</p>
                                    </div>
                                </div>
                                <div class="flex">
                                    <button type="button" onclick="openCamera('pos_reports')" class="mr-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        Camera
                                    </button>
                                    <div class="relative">
                                        <input type="file" id="pos_reports" name="pos_reports" accept=".pdf,.xls,.xlsx,.jpg,.jpeg,.png" class="hidden" onchange="handleFileSelect(this)">
                                        <label for="pos_reports" class="cursor-pointer inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                            <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                            </svg>
                                            Upload
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div id="pos_reports_preview" class="hidden mt-3 p-2 border rounded-md bg-gray-50">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs font-medium text-gray-900 document-name"></span>
                                    <button type="button" onclick="removeFile('pos_reports')" class="text-red-600 hover:text-red-800">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>

                    <!-- BIR Tax Returns -->
                    <li>
                        <div class="px-4 py-4 sm:px-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-900">BIR Tax Returns (2550M, 2550Q, 2551Q)</p>
                                        <p class="text-xs text-gray-500">PDF, JPG or PNG (Max 10MB)</p>
                                    </div>
                                </div>
                                <div class="flex">
                                    <button type="button" onclick="openCamera('tax_returns')" class="mr-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        Camera
                                    </button>
                                    <div class="relative">
                                        <input type="file" id="tax_returns" name="tax_returns" accept=".pdf,.jpg,.jpeg,.png" class="hidden" onchange="handleFileSelect(this)">
                                        <label for="tax_returns" class="cursor-pointer inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                            <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                            </svg>
                                            Upload
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div id="tax_returns_preview" class="hidden mt-3 p-2 border rounded-md bg-gray-50">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs font-medium text-gray-900 document-name"></span>
                                    <button type="button" onclick="removeFile('tax_returns')" class="text-red-600 hover:text-red-800">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>

                    <!-- Sworn Declaration of Gross Sales -->
<li>
    <div class="px-4 py-4 sm:px-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">Sworn Declaration of Gross Sales</p>
                    <p class="text-xs text-gray-500">PDF, JPG or PNG (Max 10MB)</p>
                </div>
            </div>
            <div class="flex">
                <button type="button" onclick="openCamera('sworn_declaration')" class="mr-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Camera
                </button>
                <div class="relative">
                    <input type="file" id="sworn_declaration" name="sworn_declaration" accept=".pdf,.jpg,.jpeg,.png" class="hidden" onchange="handleFileSelect(this)">
                    <label for="sworn_declaration" class="cursor-pointer inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                        </svg>
                        Upload
                    </label>
                </div>
            </div>
        </div>
        <div id="sworn_declaration_preview" class="hidden mt-3 p-2 border rounded-md bg-gray-50">
            <div class="flex items-center justify-between">
                <span class="text-xs font-medium text-gray-900 document-name"></span>
                <button type="button" onclick="removeFile('sworn_declaration')" class="text-red-600 hover:text-red-800">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</li>

<!-- Additional document: Certificate of No Change (if applicable) -->
<li>
    <div class="px-4 py-4 sm:px-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">Certificate of No Change (if applicable)</p>
                    <p class="text-xs text-gray-500">PDF, JPG or PNG (Max 10MB)</p>
                </div>
            </div>
            <div class="flex">
                <button type="button" onclick="openCamera('no_change_cert')" class="mr-2 inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Camera
                </button>
                <div class="relative">
                    <input type="file" id="no_change_cert" name="no_change_cert" accept=".pdf,.jpg,.jpeg,.png" class="hidden" onchange="handleFileSelect(this)">
                    <label for="no_change_cert" class="cursor-pointer inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                        </svg>
                        Upload
                    </label>
                </div>
            </div>
        </div>
        <div id="no_change_cert_preview" class="hidden mt-3 p-2 border rounded-md bg-gray-50">
            <div class="flex items-center justify-between">
                <span class="text-xs font-medium text-gray-900 document-name"></span>
                <button type="button" onclick="removeFile('no_change_cert')" class="text-red-600 hover:text-red-800">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</li>
                </ul>
            </div>
        </div>
        
                <!-- Document Requirements Information Box -->
        <div class="mt-4 mb-6 rounded-md bg-gray-50 p-4 border border-gray-200">
            <h4 class="text-sm font-medium text-gray-900 mb-2">Required Documents Checklist:</h4>
            <ul class="list-disc list-inside space-y-1 text-xs text-gray-700">
                <li>Previous Business Permit (Original copy)</li>
                <li>Proof of Annual Gross Receipts</li>
                <li>Breakdown of Sales per Branch (if applicable)</li>
                <li>Book of Sales or equivalent financial records</li>
                <li>POS Reports (if using point-of-sale systems)</li>
                <li>BIR Tax Returns (2550M, 2550Q, 2551Q)</li>
                <li>Sworn Declaration of Gross Sales (notarized)</li>
                <li>Certificate of No Change (if business details remain unchanged)</li>
            </ul>
            <p class="text-xs text-gray-500 mt-2">All documents must be clear, complete, and in PDF, JPG, or PNG format.</p>
        </div>

                    <!-- AI Assisted Scanning Information -->
                    <div class="rounded-md bg-blue-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="ml-3 flex-1 md:flex md:justify-between">
                                <p class="text-sm text-blue-700">
                                    Our AI-powered system will scan your documents for authenticity and extract information automatically.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Terms and Declaration -->
            <div class="mb-8">
                <div class="bg-yellow-50 p-4 rounded-md border border-yellow-200">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">Declaration</h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <p>I declare under penalty of perjury that the information provided in this form is true and accurate. I understand that providing false information may result in rejection of my application and possible legal consequences.</p>
                            </div>
                            <div class="mt-4">
                                <div class="flex items-center">
                                    <input id="declaration_agree" name="declaration_agree" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="declaration_agree" class="ml-2 block text-sm text-yellow-800">I agree to the declaration statement</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-end items-center gap-4 mt-8 pt-6 border-t border-gray-200">
                <div class="flex flex-col sm:flex-row w-full sm:w-auto gap-3">
                    <button type="submit" name="action" value="save_draft" class="w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        Save as Draft
                    </button>
                    
                    <button type="submit" name="action" value="submit" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Submit Application
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Camera Modal -->
<div id="cameraModal" class="fixed inset-0 z-10 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Take a Photo
                        </h3>
                        <div class="mt-4">
                            <div id="camera-container" class="w-full h-64 bg-gray-200 rounded-md overflow-hidden">
                                <video id="camera-stream" class="w-full h-full object-cover" autoplay></video>
                                <canvas id="camera-canvas" class="hidden w-full h-full"></canvas>
                            </div>
                            <div id="capture-ui" class="flex justify-center mt-4">
                                <button type="button" id="capture-button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <svg class="mr-1 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    </svg>
                                    Take Photo
                                </button>
                            </div>
                            <div id="retake-ui" class="hidden flex justify-center space-x-4 mt-4">
                                <button type="button" id="retake-button" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Retake
                                </button>
                                <button type="button" id="use-photo-button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Use Photo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="close-camera-button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Form control styling */
    input[type="text"], 
    input[type="number"], 
    input[type="email"], 
    input[type="date"], 
    input[type="tel"], 
    select, 
    textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #D1D5DB;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        color: #1F2937;
        background-color: #F9FAFB;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    input[type="text"]:focus, 
    input[type="number"]:focus, 
    input[type="email"]:focus, 
    input[type="date"]:focus, 
    input[type="tel"]:focus, 
    select:focus, 
    textarea:focus {
        outline: none;
        ring: 2px;
        ring-color: #3B82F6;
        border-color: #3B82F6;
    }

    /* Currency inputs */
    input[id$="gross_essential"],
    input[id$="gross_non_essential"],
    input[id$="gross_sales_receipts"] {
        padding-left: 1.75rem;
    }

    /* File upload area hover effects */
    .drag-active {
        border-color: #3B82F6;
        background-color: #EFF6FF;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-calculate the total gross sales
        const essentialInput = document.getElementById('{{ form.gross_essential.id_for_label }}');
        const nonEssentialInput = document.getElementById('{{ form.gross_non_essential.id_for_label }}');
        const totalInput = document.getElementById('{{ form.gross_sales_receipts.id_for_label }}');
        
        // Function to calculate total gross sales
        function calculateTotal() {
            const essential = parseFloat(essentialInput.value) || 0;
            const nonEssential = parseFloat(nonEssentialInput.value) || 0;
            totalInput.value = (essential + nonEssential).toFixed(2);
        }
        
        // Add event listeners for input changes
        essentialInput.addEventListener('input', calculateTotal);
        nonEssentialInput.addEventListener('input', calculateTotal);
        
        // Initial calculation
        calculateTotal();
        
        // Set read-only attribute for total field
        totalInput.setAttribute('readonly', true);
        
        // Form validation before submission
        const renewalForm = document.getElementById('renewalForm');
        const declarationCheckbox = document.getElementById('declaration_agree');
        const submitButton = document.querySelector('button[value="submit"]');
        
        renewalForm.addEventListener('submit', function(e) {
            if (e.submitter && e.submitter.value === 'submit') {
                if (!declarationCheckbox.checked) {
                    e.preventDefault();
                    alert('Please agree to the declaration statement before submitting.');
                    return false;
                }
                
                // Check for required fields
                const requiredFields = [
                    '{{ form.payment_mode.id_for_label }}',
                    '{{ form.previous_permit_number.id_for_label }}',
                    '{{ form.business_name.id_for_label }}'
                ];
                
                for (const fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        e.preventDefault();
                        field.classList.add('border-red-500');
                        field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        alert('Please fill in all required fields before submitting.');
                        return false;
                    }
                }
            }
        });
        
        // Remove red border when user starts typing in a field marked as error
        document.querySelectorAll('input, select, textarea').forEach(element => {
            element.addEventListener('input', function() {
                this.classList.remove('border-red-500');
            });
        });
        
        // Camera and document handling code
        let currentCameraField = null;
        let mediaStream = null;
        
        // Camera handling functions
        window.openCamera = function(fieldName) {
            currentCameraField = fieldName;
            const cameraModal = document.getElementById('cameraModal');
            
            if (!cameraModal) {
                console.error("Camera modal not found in the DOM");
                return;
            }
            
            const cameraStream = document.getElementById('camera-stream');
            const cameraCanvas = document.getElementById('camera-canvas');
            const captureUI = document.getElementById('capture-ui');
            const retakeUI = document.getElementById('retake-ui');
            
            if (!cameraStream || !cameraCanvas || !captureUI || !retakeUI) {
                console.error("Camera elements not found");
                return;
            }
            
            cameraModal.classList.remove('hidden');
            captureUI.classList.remove('hidden');
            retakeUI.classList.add('hidden');
            cameraStream.classList.remove('hidden');
            cameraCanvas.classList.add('hidden');
            
            // Request camera access
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(stream) {
                    mediaStream = stream;
                    cameraStream.srcObject = stream;
                })
                .catch(function(err) {
                    console.error('Camera error:', err);
                    alert('Unable to access camera. Please use the upload option instead.');
                    closeCameraModal();
                });
        };
        
        // Close camera modal and clean up
        function closeCameraModal() {
            const cameraModal = document.getElementById('cameraModal');
            
            if (cameraModal) {
                cameraModal.classList.add('hidden');
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
        }
        
        // Setup camera button handlers
        const captureButton = document.getElementById('capture-button');
        const retakeButton = document.getElementById('retake-button');
        const usePhotoButton = document.getElementById('use-photo-button');
        const closeCameraButton = document.getElementById('close-camera-button');
        
        // Check if buttons exist before adding event listeners
        if (captureButton) {
            captureButton.addEventListener('click', function() {
                const cameraStream = document.getElementById('camera-stream');
                const cameraCanvas = document.getElementById('camera-canvas');
                const captureUI = document.getElementById('capture-ui');
                const retakeUI = document.getElementById('retake-ui');
                
                if (!cameraStream || !cameraCanvas || !captureUI || !retakeUI) {
                    console.error("Camera elements not found for capture");
                    return;
                }
                
                const context = cameraCanvas.getContext('2d');
                cameraCanvas.width = cameraStream.videoWidth;
                cameraCanvas.height = cameraStream.videoHeight;
                
                context.drawImage(cameraStream, 0, 0, cameraCanvas.width, cameraCanvas.height);
                
                captureUI.classList.add('hidden');
                retakeUI.classList.remove('hidden');
                cameraStream.classList.add('hidden');
                cameraCanvas.classList.remove('hidden');
            });
        }
        
        if (retakeButton) {
            retakeButton.addEventListener('click', function() {
                const captureUI = document.getElementById('capture-ui');
                const retakeUI = document.getElementById('retake-ui');
                const cameraStream = document.getElementById('camera-stream');
                const cameraCanvas = document.getElementById('camera-canvas');
                
                if (captureUI && retakeUI && cameraStream && cameraCanvas) {
                    captureUI.classList.remove('hidden');
                    retakeUI.classList.add('hidden');
                    cameraStream.classList.remove('hidden');
                    cameraCanvas.classList.add('hidden');
                }
            });
        }
        
        if (usePhotoButton) {
            usePhotoButton.addEventListener('click', function() {
                if (currentCameraField) {
                    const cameraCanvas = document.getElementById('camera-canvas');
                    
                    if (!cameraCanvas) {
                        console.error("Camera canvas not found");
                        return;
                    }
                    
                    cameraCanvas.toBlob(function(blob) {
                        const fileName = `camera_capture_${Date.now()}.jpg`;
                        const file = new File([blob], fileName, { type: 'image/jpeg' });
                        
                        // Create a DataTransfer object (browser's way to handle files)
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        
                        // Set file input value
                        const fileInput = document.getElementById(currentCameraField);
                        
                        if (fileInput) {
                            fileInput.files = dataTransfer.files;
                            
                            // Trigger change event to update UI
                            const event = new Event('change', { bubbles: true });
                            fileInput.dispatchEvent(event);
                        } else {
                            console.error("File input not found:", currentCameraField);
                        }
                        
                        // Close modal
                        closeCameraModal();
                    }, 'image/jpeg', 0.95);
                }
            });
        }
        
        if (closeCameraButton) {
            closeCameraButton.addEventListener('click', closeCameraModal);
        }
        
        // Handle file selection
        window.handleFileSelect = function(input) {
            if (input && input.files && input.files[0]) {
                const file = input.files[0];
                const fieldName = input.id;
                const previewDiv = document.getElementById(`${fieldName}_preview`);
                
                if (!previewDiv) {
                    console.error(`Preview div not found for ${fieldName}`);
                    return;
                }
                
                const nameSpan = previewDiv.querySelector('.document-name');
                
                if (nameSpan) {
                    // Update preview with file name
                    nameSpan.textContent = file.name;
                    previewDiv.classList.remove('hidden');
                    
                    // Call AI validation service (simulated)
                    validateDocument(file, fieldName);
                } else {
                    console.error(`Name span not found in preview div for ${fieldName}`);
                }
            }
        };
        
        // Remove file
        window.removeFile = function(fieldName) {
            const input = document.getElementById(fieldName);
            const previewDiv = document.getElementById(`${fieldName}_preview`);
            
            if (input && previewDiv) {
                // Clear file input
                input.value = '';
                
                // Hide preview
                previewDiv.classList.add('hidden');
                
                // Remove any validation indicators
                const indicator = previewDiv.querySelector('.validation-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        };
        
        // Simulate AI document validation
        function validateDocument(file, fieldName) {
            // In a real implementation, you would send the file to the server for AI validation
            console.log(`Validating ${file.name} for ${fieldName}...`);
            
            // Simulate server processing time
            setTimeout(function() {
                const previewDiv = document.getElementById(`${fieldName}_preview`);
                
                if (!previewDiv) {
                    console.error(`Preview div not found for ${fieldName} during validation`);
                    return;
                }
                
                const documentNameElement = previewDiv.querySelector('.document-name');
                
                if (!documentNameElement) {
                    console.error(`Document name element not found in preview for ${fieldName}`);
                    return;
                }
                
                // Remove any existing validation indicator
                const existingIndicator = documentNameElement.querySelector('.validation-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
                
                // Add validation indicator (green checkmark)
                const validationSpan = document.createElement('span');
                validationSpan.className = 'inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 ml-2 validation-indicator';
                validationSpan.innerHTML = `
                    <svg class="mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Validated
                `;
                
                documentNameElement.appendChild(validationSpan);
                console.log(`Document ${file.name} validated successfully`);
            }, 1500);
        }
    });
</script>
{% endblock %}