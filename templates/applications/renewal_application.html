{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-6">Business Permit Renewal</h2>

        <form method="post" enctype="multipart/form-data" id="renewalForm">
            {% csrf_token %}
            
            {% if form.errors %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                Please correct the following errors:
                {{ form.errors }}
            </div>
            {% endif %}
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-4">Basic Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Mode of Payment*</label>
                        {{ form.payment_mode }}
                        {% if form.payment_mode.errors %}
                        <p class="text-red-500 text-sm">{{ form.payment_mode.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Business Name*</label>
                        {{ form.business_name }}
                        {% if form.business_name.errors %}
                        <p class="text-red-500 text-sm">{{ form.business_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-4">Business Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Business Address*</label>
                        {{ form.business_address }}
                        {% if form.business_address.errors %}
                        <p class="text-red-500 text-sm">{{ form.business_address.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Postal Code*</label>
                        {{ form.postal_code }}
                        {% if form.postal_code.errors %}
                        <p class="text-red-500 text-sm">{{ form.postal_code.errors.0 }}</p>
                        {% endif %}
                    </div>
                <div>
    <label class="block text-gray-700 mb-2">Registration Number*</label>
    {{ form.registration_number }}
    {% if form.registration_number.errors %}
    <p class="text-red-500 text-sm">{{ form.registration_number.errors.0 }}</p>
    {% endif %}
</div>
<div>
    <label class="block text-gray-700 mb-2">Registration Date*</label>
    {{ form.registration_date }}
    {% if form.registration_date.errors %}
    <p class="text-red-500 text-sm">{{ form.registration_date.errors.0 }}</p>
    {% endif %}
</div>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-4">Contact Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Telephone*</label>
                        {{ form.telephone }}
                        {% if form.telephone.errors %}
                        <p class="text-red-500 text-sm">{{ form.telephone.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Email*</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                        <p class="text-red-500 text-sm">{{ form.email.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-4">Financial Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Essential Goods Sales*</label>
                        {{ form.gross_essential }}
                        {% if form.gross_essential.errors %}
                        <p class="text-red-500 text-sm">{{ form.gross_essential.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Non-Essential Goods Sales*</label>
                        {{ form.gross_non_essential }}
                        {% if form.gross_non_essential.errors %}
                        <p class="text-red-500 text-sm">{{ form.gross_non_essential.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Total Gross Sales</label>
                        {{ form.gross_sales_receipts }}
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-4">Required Documents</h3>
                <div class="grid grid-cols-1 gap-4">
                    <div class="border rounded p-4">
                        <label class="block text-gray-700 mb-2">Previous Business Permit*</label>
                        <input type="file" name="business_permit" accept=".pdf,.jpg,.png" required>
                    </div>
                    <div class="border rounded p-4">
                        <label class="block text-gray-700 mb-2">Gross Sales Declaration*</label>
                        <input type="file" name="sales_declaration" accept=".pdf,.jpg,.png" required>
                    </div>
                    <div class="border rounded p-4">
                        <label class="block text-gray-700 mb-2">Tax Returns*</label>
                        <input type="file" name="tax_returns" accept=".pdf" required>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-4">
                <button type="submit" name="action" value="save_draft" 
                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    Save as Draft
                </button>
                <button type="submit" name="action" value="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Submit Application
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('renewalForm');
    const grossEssential = form.querySelector('[name="gross_essential"]');
    const grossNonEssential = form.querySelector('[name="gross_non_essential"]');
    const totalGross = form.querySelector('[name="gross_sales_receipts"]');

    function calculateTotal() {
        const essential = parseFloat(grossEssential.value) || 0;
        const nonEssential = parseFloat(grossNonEssential.value) || 0;
        totalGross.value = (essential + nonEssential).toFixed(2);
    }

    grossEssential.addEventListener('input', calculateTotal);
    grossNonEssential.addEventListener('input', calculateTotal);

    form.addEventListener('submit', function(e) {
        const action = e.submitter.value;
        if (action === 'submit') {
            const requiredFiles = ['business_permit', 'sales_declaration', 'tax_returns'];
            for (const fileInput of requiredFiles) {
                const input = form.querySelector(`input[name="${fileInput}"]`);
                if (!input.files.length) {
                    e.preventDefault();
                    alert(`Please upload ${fileInput.replace('_', ' ')}`);
                    return;
                }
            }
        }
    });
});
</script>
{% endblock %}